name: Pull Request Tests

on:
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.13'

jobs:
  test:
    name: Run All Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock
    
    - name: Run Unit Tests
      run: |
        echo "ğŸ§ª Running Unit Tests..."
        pytest tests/unit -v --tb=short
    
    - name: Run Integration Tests
      run: |
        echo "ğŸ”— Running Integration Tests..."
        pytest tests/integration -v --tb=short --ignore=tests/integration/test_integration_deployment.py
    
    - name: Generate Coverage Report
      run: |
        pytest tests/unit tests/integration --cov=. --cov-report=term --cov-report=html --ignore=tests/integration/test_integration_deployment.py
    
    - name: Upload Coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report-pr-${{ github.event.pull_request.number }}
        path: htmlcov/
        retention-days: 7
    
    - name: Comment PR with Results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const testResults = `
          ## ğŸ§ª Test Results
          
          âœ… Unit Tests: Completed
          âœ… Integration Tests: Completed
          ğŸ“Š Coverage Report: Available in artifacts
          
          **Commit:** ${{ github.sha }}
          **Branch:** ${{ github.head_ref }}
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: testResults
          });

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install linting tools
      run: |
        pip install black flake8
    
    - name: Check formatting
      run: |
        echo "ğŸ¨ Checking code formatting..."
        black --check . || (echo "âŒ Code needs formatting. Run 'black .' to fix." && exit 1)
    
    - name: Lint code
      run: |
        echo "ğŸ” Linting code..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
