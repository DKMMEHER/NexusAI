worker_processes 1;

events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 8080; # Cloud Run expects port 8080
        client_max_body_size 50M;

        root /app/frontend/dist; # Serve built React app
        index index.html;

        # Frontend Routes (Single Page App Fallback)
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Health Checks
        location /health/image { proxy_pass http://127.0.0.1:8000/image/health; }
        location /health/video { proxy_pass http://127.0.0.1:8002/health; }
        location /health/docs { proxy_pass http://127.0.0.1:8003/health; }
        location /health/youtube { proxy_pass http://127.0.0.1:8004/health; }
        location /health/chat { proxy_pass http://127.0.0.1:8005/health; }
        location /health/director { proxy_pass http://127.0.0.1:8006/health; }

        # Service 1: Image Generation (8000)
        location /image/ {
            proxy_pass http://127.0.0.1:8000;
        }

        # Service 2: Video Generation (8002) - Maps individual endpoints
        location /text_to_video { proxy_pass http://127.0.0.1:8002; }
        location /image_to_video { proxy_pass http://127.0.0.1:8002; }
        location /video_from_reference_images { proxy_pass http://127.0.0.1:8002; }
        location /video_from_first_last_frames { proxy_pass http://127.0.0.1:8002; }
        location /extend_veo_video { proxy_pass http://127.0.0.1:8002; }
        location /status/ { proxy_pass http://127.0.0.1:8002; }
        location /save_local/ { proxy_pass http://127.0.0.1:8002; }
        location /download/ { proxy_pass http://127.0.0.1:8002; }

        # Service 3: Documents Summarization (8003)
        # Note: Frontend calls /summarize directly? or /api/documents?
        # Checking vite.config.js: /summarize -> 8003, /api/documents -> 8003
        # Service 3: Documents Summarization (8003)
        location /summarize { proxy_pass http://127.0.0.1:8003; }
        location /api/documents/ { 
            rewrite ^/api/documents/(.*) /$1 break;
            proxy_pass http://127.0.0.1:8003; 
        }

        # Service 4: YouTube Transcript (8004)
        location /transcript { proxy_pass http://127.0.0.1:8004; }
        location /api/youtube/ { 
            rewrite ^/api/youtube/(.*) /$1 break;
            proxy_pass http://127.0.0.1:8004; 
        }

        # Service 5: Chat (8005)
        location /chat { proxy_pass http://127.0.0.1:8005; }
        location /api/chat/ { 
            rewrite ^/api/chat/(.*) /$1 break;
            proxy_pass http://127.0.0.1:8005; 
        }

        # Service 6: Director (8006)
        location /director/ {
            # Rewrite /director/xyz -> /xyz because Director app is mounted at root
            # But wait, backend.py defines @app.post("/create_movie").
            # Frontend calls /director/create_movie.
            # So we proxy /director/ -> http://127.0.0.1:8006/
            rewrite ^/director/(.*) /$1 break;
            proxy_pass http://127.0.0.1:8006;
        }
    }
}
