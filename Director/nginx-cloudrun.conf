worker_processes 1;

events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    server {
        listen 8080; # Cloud Run expects port 8080
        client_max_body_size 50M;

        root /app/frontend/dist; # Serve built React app
        index index.html;

        # Frontend Routes (Single Page App Fallback)
        location / {
            try_files $uri $uri/ /index.html;
        }

        # Image Generation Service
        location /image/ {
            rewrite ^/image/(.*) /$1 break;
            proxy_pass https://imagegeneration-962267416185.asia-south1.run.app;
            proxy_set_header Host imagegeneration-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Video Generation Service
        location /text_to_video {
            proxy_pass https://videogeneration-962267416185.asia-south1.run.app/text_to_video;
            proxy_set_header Host videogeneration-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /image_to_video {
            proxy_pass https://videogeneration-962267416185.asia-south1.run.app/image_to_video;
            proxy_set_header Host videogeneration-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /video_from_reference_images {
            proxy_pass https://videogeneration-962267416185.asia-south1.run.app/video_from_reference_images;
            proxy_set_header Host videogeneration-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /video_from_first_last_frames {
            proxy_pass https://videogeneration-962267416185.asia-south1.run.app/video_from_first_last_frames;
            proxy_set_header Host videogeneration-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /extend_veo_video {
            proxy_pass https://videogeneration-962267416185.asia-south1.run.app/extend_veo_video;
            proxy_set_header Host videogeneration-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /status/ {
            proxy_pass https://videogeneration-962267416185.asia-south1.run.app/status/;
            proxy_set_header Host videogeneration-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /download/ {
            proxy_pass https://videogeneration-962267416185.asia-south1.run.app/download/;
            proxy_set_header Host videogeneration-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Chat Service
        location /chat {
            proxy_pass https://chat-962267416185.asia-south1.run.app/chat;
            proxy_set_header Host chat-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /api/chat/ {
            rewrite ^/api/chat/(.*) /$1 break;
            proxy_pass https://chat-962267416185.asia-south1.run.app;
            proxy_set_header Host chat-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Document Summarization Service
        location /summarize {
            proxy_pass https://documentssummarization-962267416185.asia-south1.run.app/summarize;
            proxy_set_header Host documentssummarization-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /api/documents/ {
            rewrite ^/api/documents/(.*) /$1 break;
            proxy_pass https://documentssummarization-962267416185.asia-south1.run.app;
            proxy_set_header Host documentssummarization-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # YouTube Transcript Service
        location /transcript {
            proxy_pass https://youtubetranscript-962267416185.asia-south1.run.app/transcript;
            proxy_set_header Host youtubetranscript-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        location /api/youtube/ {
            rewrite ^/api/youtube/(.*) /$1 break;
            proxy_pass https://youtubetranscript-962267416185.asia-south1.run.app;
            proxy_set_header Host youtubetranscript-962267416185.asia-south1.run.app;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Director API endpoints
        location /director/ {
            rewrite ^/director/(.*) /$1 break;
            proxy_pass http://127.0.0.1:8006;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Director health check
        location /health {
            proxy_pass http://127.0.0.1:8006/health;
        }
    }
}
