name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.13'
  PROJECT_ID: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
  REGION: asia-south1

jobs:
  # Job 1: Run Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock
    
    - name: Run Unit Tests
      run: |
        pytest tests/unit -v --tb=short
      continue-on-error: false
    
    - name: Run Integration Tests
      run: |
        pytest tests/integration -v --tb=short --ignore=tests/integration/test_integration_deployment.py
      continue-on-error: false
    
    - name: Generate Coverage Report
      run: |
        pytest tests/unit tests/integration --cov=. --cov-report=xml --cov-report=html --ignore=tests/integration/test_integration_deployment.py
      continue-on-error: true
    
    - name: Upload Coverage Report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 30
    
    - name: Display Test Summary
      if: always()
      run: |
        echo "‚úÖ Unit Tests: Completed"
        echo "‚úÖ Integration Tests: Completed"
        echo "üìä Coverage Report: Generated"

  # Job 2: Code Quality Checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install linting tools
      run: |
        pip install black flake8 pylint
    
    - name: Check code formatting with Black
      run: |
        black --check . || echo "‚ö†Ô∏è Code formatting issues found. Run 'black .' to fix."
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

  # Job 3: Build Docker Images (only on main branch)
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test, quality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    strategy:
      matrix:
        service: 
          - ImageGeneration
          - Chat
          - Director
          - VideoGeneration
          - DocumentsSummarization
          - YoutubeTranscript
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Create Artifact Registry Repository (if not exists)
      run: |
        gcloud artifacts repositories create nexusai-repo \
          --repository-format=docker \
          --location=${{ env.REGION }} \
          --description="NexusAI Docker images for microservices" \
          --project=${{ env.PROJECT_ID }} \
          || echo "‚úÖ Repository 'nexusai-repo' already exists"
      continue-on-error: true
    
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev
    
    - name: Build and Push Docker Image
      timeout-minutes: 15
      run: |
        SERVICE_LOWER=$(echo "${{ matrix.service }}" | tr '[:upper:]' '[:lower:]')
        IMAGE_NAME="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/nexusai-repo/${SERVICE_LOWER}:${{ github.sha }}"
        IMAGE_LATEST="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/nexusai-repo/${SERVICE_LOWER}:latest"
        
        echo "Building ${{ matrix.service }}..."
        docker build -t $IMAGE_NAME -t $IMAGE_LATEST -f ${{ matrix.service }}/Dockerfile .
        
        echo "Pushing ${{ matrix.service }}..."
        docker push $IMAGE_NAME
        docker push $IMAGE_LATEST
        
        echo "‚úÖ Built and pushed: ${{ matrix.service }}"

  # Job 4: Deploy to Cloud Run (only on main branch)
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    strategy:
      matrix:
        service:
          - name: ImageGeneration
            port: 8001
          - name: Chat
            port: 8005
          - name: Director
            port: 8006
          - name: VideoGeneration
            port: 8002
          - name: DocumentsSummarization
            port: 8003
          - name: YoutubeTranscript
            port: 8004
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
    
    - name: Deploy to Cloud Run
      run: |
        SERVICE_NAME=$(echo "${{ matrix.service.name }}" | tr '[:upper:]' '[:lower:]')
        IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/nexusai-repo/${SERVICE_NAME}:${{ github.sha }}"
        
        gcloud run deploy $SERVICE_NAME \
          --image $IMAGE \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port ${{ matrix.service.port }} \
          --set-env-vars "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" \
          --set-env-vars "GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}" \
          --memory 2Gi \
          --cpu 2 \
          --timeout 300 \
          --max-instances 10 \
          --min-instances 0
        
        echo "‚úÖ Deployed: ${{ matrix.service.name }}"
    
    - name: Get Service URL
      run: |
        SERVICE_NAME=$(echo "${{ matrix.service.name }}" | tr '[:upper:]' '[:lower:]')
        URL=$(gcloud run services describe $SERVICE_NAME --region ${{ env.REGION }} --format 'value(status.url)')
        echo "üåê ${{ matrix.service.name }} URL: $URL"

  # Job 5: Post-Deployment Health Check
  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Wait for deployment to stabilize
      run: sleep 30
    
    - name: Check service health
      run: |
        SERVICES=("imagegeneration" "chat" "director" "videogeneration" "documentssummarization" "youtubetranscript")
        
        for SERVICE in "${SERVICES[@]}"; do
          URL="https://$SERVICE-${{ secrets.CLOUD_RUN_SUFFIX }}.run.app/health"
          echo "Checking $SERVICE..."
          
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ $SERVICE is healthy"
          else
            echo "‚ùå $SERVICE health check failed (HTTP $RESPONSE)"
          fi
        done

  # Job 6: Notification
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [test, quality, deploy, health-check]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Deployment Success
      if: needs.deploy.result == 'success' && needs.health-check.result == 'success'
      run: |
        echo "üéâ Deployment successful!"
        echo "‚úÖ All tests passed"
        echo "‚úÖ All services deployed"
        echo "‚úÖ Health checks passed"
    
    - name: Deployment Failed
      if: needs.deploy.result == 'failure' || needs.health-check.result == 'failure'
      run: |
        echo "‚ùå Deployment failed!"
        exit 1
